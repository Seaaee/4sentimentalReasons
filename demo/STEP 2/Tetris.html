<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <meta
        http-equiv="X-UA-Compatible"
        content="ie=edge"
    >
    <link rel="shortcut icon" href="2k.jpg" type="image/x-icon">
    <title>俄罗斯方块</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%
        }

        ul,
        li {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        body {
            color: rgb(36, 34, 34);
            font-size: 12px;
            display: flex;
            justify-content: center;
            background: #f6f6f6
        }

        #play_area,
        #play_menu {
            margin-top: 100px;
        }

        #play_area {
            display: flex;
            width: 300px;
            height: 480px;
            border-radius: 2px;
            box-shadow: 0 0 8px #000;
            background-image:linear-gradient(transparent 0,rgba(6, 6, 6, 0.744) 1px),
                             linear-gradient(90deg,transparent 0,rgba(6, 6, 6, 0.744) 1px);
            background-size: 20px 20px
        }

        #play_area .play_cell{
            width: 19px;
            height: 19px;
            border: 1px solid transparent;
            background: #444;
        }
        #play_area .active {
            position: absolute;
        }


        #play_menu {
            margin-left: 80px;
            padding-top: 10px;
            font-size: 1rem;
        }

        #play_menu #play_nextType {
            width: 60px;
            height: 60px;
        }

        #play_menu #play_nextType .play_cell {
            width: 14px;
            height: 14px;
        }

        #play_menu #play_nextType .play_cell,
        #play_area .play_cell {
            border: 1px solid #eee;
            margin: 0 -1px -1px 0;
        }

        button {
            background: #fefefe;
            border: 1px solid #ccc;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            animation: rainbow 0.8s ease-in infinite alternate;
        }

        @keyframes rainbow {
           
            
            0% {
                background: rgb(225, 234, 250);
            }

            100% {
                background: rgb(203, 221, 229);
            }
        }

        button .acc {
            background: #666;
            color: #eee
        }
        button .acc:hover{
            background: #333
        } 
        
        #play_btn_start {
            height: 70px;
            width: 160px;
            margin: 40px 10px 0;
            font-size: 1.3rem;
            color: rgb(36, 61, 88);
            font-weight: bolder;
        }

        #play_menu ul {
            display: flex;
            margin-top: 20px;
            width: 180px;
            justify-content: space-evenly
        }

        #play_menu ul li {
            width: 50px;
        }

        #play_menu ul li button {
            height: 50px;
            border-radius: 50%
        }

        #play_score {
            width: 180px;
            height: 160px;
            font-size: 8rem;
            line-height: 160px;
            text-align: center;
            margin-top: 20px;
            font-weight: bold;
            font-family: Impact, Haettenschweiler, 'Arial Narrow Bold';
        }

    </style>
</head>

<body>
    <main
        class='wrap'
        id='play_area'
    >
    </main>
    <nav id='play_menu'>
        <p>下一个：</p>
        <div id="play_nextType"></div>
        <button
            id="play_btn_start"
            class='play_btn'
        >开始
        </button>
        <ul>
            <li><button>慢</button></li>
            <li><button>还行</button></li>
            <li><button>快</button></li>
        </ul>
        <div id='play_score'>0</div>
    </nav>
    <script>
        'use strict';

        class Tetris{
            constructor(){
                this.activeCell=document.getElementsByClassName('active');
                this.nowArr=undefined;
                this.playArea=document.getElementById('play_area')
                this.playSize={
                    width:300,
                    height:480,
                    left:this.getDistance(true),
                    top:this.getDistance(false)
                }

                this.CELLSIZE=20;
                this.BLOCK1=[[1,0],[1,0],[1,1]]
            }
            getDistance(r){
                return r?this.playArea.offsetLeft:this.playArea.offsetTop
            }


            getMidIndexArr(len) {
                let mid = Math.floor(len / 2)
                return Array.from(new Array(len), (z, index) => index - mid)
            }


            getActivePos(){
                let tops = [], lefts = [];
                Array.from(this.activeCell).forEach((itm) => {
                    tops.push(parseInt(itm.style.top))
                    lefts.push(parseInt(itm.style.left))
                })
                let bottom = Math.max(...tops),
                    left = Math.min(...lefts),
                    right = Math.max(...lefts),
                    top = Math.min(...tops);
                return{
                    bottom:bottom,
                    left:left,
                    right:right,
                    top:top
                }
            }





            /**
                ↑ 变形
                变形之后的left是之前的left   top是mid top   必定不会出界
            */
            turn(){
                let col=this.nowArr.length,
                    row=this.nowArr[0].length,
                    arrTurn=[];
                for(let i=0;i<row;i++){
                    let tmp=[]
                    for(let j=0;j<col;j++){
                        tmp.push(this.nowArr[col-1-j][i])
                    }
                    arrTurn.push(tmp)
                }
                this.nowArr=[...arrTurn]


                let {left,top,bottom}=this.getActivePos(),
                    midHeight=Math.ceil((top+bottom)/40),
                    lefts=[],tops=[];
                for(let i=0;i<arrTurn.length;i++){
                    let colDex=this.getMidIndexArr(arrTurn.length)
                    for(let j=0;j<arrTurn[i].length;j++){
                        if(arrTurn[i][j]===1){
                            lefts.push(left + j * this.CELLSIZE);
                            tops.push((midHeight+colDex[i])*this.CELLSIZE)
                        }
                    }
                }
                if(Math.max(...lefts)> this.playSize.left + this.playSize.width - 20){
                    lefts.forEach((itm,index)=>lefts[index]=itm-20)
                }
                return {
                    lefts:lefts,
                    tops:tops,
                }
                
                
            }


            /**                 
                判断是否可以移动
                @param r   //方向 1左  2右  else下
            */
            canMove(r){ 
                let {bottom,left,right}=this.getActivePos()
                if(r===1){
                    return left<=this.playSize.left?false:true;
                }else if(r===2){
                    return right+this.CELLSIZE>=this.playSize.left+this.playSize.width?false:true;
                }
                return bottom+this.CELLSIZE>=this.playSize.top+this.playSize.height?false:true
            }



            /**
                移动 move()  this.CELLSIZEpx
            */
            move(){ 
                let othis=this
                document.onkeydown=function(e){
                    const key=e.keyCode;
                    switch(key){
                        case 37:
                            if(othis.canMove(1)){
                                for(let cell of othis.activeCell){
                                    cell.style.left=`${parseInt(cell.style.left) - othis.CELLSIZE}px`
                                }
                            }
                            break;
                        case 38:
                            let {tops,lefts}=othis.turn();

                            for(let i in othis.activeCell){
                                othis.activeCell[i].style.left=`${lefts[i]}px`;
                                othis.activeCell[i].style.top=`${tops[i]}px`
                            }
                            break;
                        case 39:
                            if(othis.canMove(2)){
                                for(let cell of othis.activeCell){
                                    cell.style.left=`${parseInt(cell.style.left)+othis.CELLSIZE}px`
                                }
                            }
                            break;
                        case 40: 
                            if(othis.canMove('funk!!!')){
                                for(let cell of othis.activeCell){
                                    cell.style.top=`${parseInt(cell.style.top)+othis.CELLSIZE}px`
                                }
                            }
                            break;
                        default:
                            break;
                    }
                }
            }


            
            /**
            *  新的小方块出现在頂端
            *  @param i
            *  @param j
            *  @param blcok
            */
            initDraw(block){
                let len=block.length
                for(let i=0;i<len;i++){
                    let rowdex=this.getMidIndexArr(block[i].length)
                    for (let j=0;j<len;j++){
                        if(block[i][j]===1){
                            let newBlock=document.createElement('div')
                            newBlock.className='play_cell active'
                            newBlock.style.top=`${this.playSize.top+i*this.CELLSIZE}px`
                            newBlock.style.left=`${this.playSize.left+(parseInt(this.playSize.width/40)+rowdex[j])*20}px`
                            this.playArea.appendChild(newBlock)
                        }
                    }
                }
            }

            init(){
                // this.nowArr=Math.random
                this.nowArr=[...this.BLOCK1];
                this.initDraw(this.nowArr);
                this.move()
            }
            
        }
        window.onload=()=>{
            const block1=[[1,0],[1,0],[1,1]];
            let go=new Tetris();
            go.init()
        }
    </script>
</body>

</html>
